# Telegram Broadcast Bot

## Оглавление

1. [Требования](#требования)
2. [Установка и настройка](#установка-и-настройка)
3. [Создание базы данных](#создание-базы-данных)
4. [Запуск webhook-сервера](#запуск-webhook-сервера)
5. [Установка webhook](#установка-webhook)
6. [Настройка cron для рассылок](#настройка-cron-для-рассылок)
7. [Использование бота](#использование-бота)

---

## Требования

* PHP ≥ 7.4 с расширениями `pdo_mysql` и `curl`
* MySQL ≥ 5.7
* Доступ к публичному URL для webhook (HTTPS)

---

## Установка и настройка

1. Клонируйте репозиторий:

   ```bash
   git clone https://your.repo/telegram-bot.git
   cd telegram-bot
   ```
2. Скопируйте `example.config.php` в `config.php` и заполните:

    * `BOT_TOKEN` — токен бота от @BotFather.
    * `WEBHOOK_URL` — публичный URL до `bot.php`.
    * `WEBHOOK_SECRET` — любой секретный токен для проверки запросов.
    * Данные БД и список `ADMINS`.
    * `MAX_MESSAGES_PER_RUN` — лимит сообщений за один запуск `run_broadcast.php` (0 — без ограничений).
    * `WELCOME_MESSAGE` — текст ответа на команду `/start`.

---

## Создание базы данных

1. Зайдите в MySQL и создайте БД:

   ```sql
   CREATE DATABASE telegram_bot CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   ```
2. Примените схему:

   ```bash
   mysql -u db_user -p telegram_bot < schema.sql
   ```

---

## Запуск webhook-сервера

Запустите встроенный сервер PHP (для тестов):

```bash
php -S 0.0.0.0:8080 bot.php
```

Или настройте vhost в Apache / Nginx, указывая корень на папку с `bot.php`.

---

## Установка webhook

```bash
php set_webhook.php
```

После успешного выполнения Telegram будет слать обновления на ваш `bot.php`.

---

## Настройка cron для рассылок

Чтобы рассылки запускались автоматически, добавьте в crontab:

```
* * * * * /usr/bin/php /path/to/telegram-bot/run_broadcast.php 500
```

Значение `500` здесь ограничивает число сообщений, отправляемых за один запуск.
Если параметр опущен, используется `MAX_MESSAGES_PER_RUN` из `config.php`.

Этот скрипт каждую минуту будет «захватывать» и обрабатывать новые рассылки.

---

## Использование бота

* `/start` — зарегистрировать чат.
* `/broadcast` (только для админов) — начать новую массовую рассылку. Бот запросит текст, затем запустит отправку.
* Админ получит промежуточные отчёты по каждому батчу и итоговый отчёт по завершении.
* Если процесс рассылки был прерван, при следующем запуске скрипт продолжит с места остановки.
